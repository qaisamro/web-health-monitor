name: Build and Deploy to Azure AKS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest flake8
        
    - name: Lint with flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        
    - name: Run tests
      run: |
        python -m pytest

  build-and-push:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
    - uses: actions/checkout@v3

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Build and Push to ACR
      run: |
        AZURE_ACR_NAME="healthmonitorregistry"
        az acr login --name $AZURE_ACR_NAME
        docker build -t $AZURE_ACR_NAME.azurecr.io/api:${{ github.sha }} -t $AZURE_ACR_NAME.azurecr.io/api:latest .
        docker push $AZURE_ACR_NAME.azurecr.io/api:${{ github.sha }}
        docker push $AZURE_ACR_NAME.azurecr.io/api:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
    - uses: actions/checkout@v3

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set AKS Context
      uses: azure/aks-set-context@v3
      with:
        resource-group: 'web-health-monitor-rg'
        cluster-name: 'health-monitor-aks'

    - name: Deploy to AKS
      run: |
        kubectl apply -f k8s/deployment.yaml
        kubectl set image deployment/api-deployment api=healthmonitorregistry.azurecr.io/api:${{ github.sha }}
        kubectl set image deployment/worker-deployment worker=healthmonitorregistry.azurecr.io/api:${{ github.sha }}
        kubectl rollout status deployment/api-deployment
        kubectl rollout status deployment/worker-deployment

