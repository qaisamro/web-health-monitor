<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Web Health Monitor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .badge-up { background: #198754; }
    .badge-down { background: #dc3545; }
    .badge-unknown { background: #6c757d; }
    .small-muted { color: #6c757d; font-size: .9rem; }
    .table td, .table th { vertical-align: middle; }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <span class="navbar-brand">Web Health Monitor</span>
      <div class="d-flex gap-2">
        <button id="btnRunOnce" class="btn btn-outline-light btn-sm">Run checks now</button>
        <button id="btnRefresh" class="btn btn-outline-light btn-sm">Refresh</button>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="row g-3">
      <div class="col-lg-4">
        <div class="card shadow-sm">
          <div class="card-header">
            <strong>Add Monitor</strong>
          </div>
          <div class="card-body">
            <form id="addForm" class="vstack gap-2">
              <div>
                <label class="form-label">Name</label>
                <input class="form-control" name="name" placeholder="My Website" required>
              </div>
              <div>
                <label class="form-label">URL</label>
                <input class="form-control mono" name="url" placeholder="https://example.com" required>
              </div>
              <div>
                <label class="form-label">Interval (seconds)</label>
                <input class="form-control" name="interval_seconds" type="number" min="10" max="3600" value="60" required>
                <div class="small-muted mt-1">MVP uses a global scheduler (every 60s). Interval is stored for future extension.</div>
              </div>
              <button class="btn btn-primary mt-2" type="submit">Add</button>
            </form>
            <div id="msg" class="alert alert-info mt-3 d-none"></div>
          </div>
        </div>

        <div class="card shadow-sm mt-3">
          <div class="card-header">
            <strong>Auto refresh</strong>
          </div>
          <div class="card-body">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
              <label class="form-check-label" for="autoRefresh">
                Refresh every 10 seconds
              </label>
            </div>
          </div>
        </div>

      </div>

      <div class="col-lg-8">
        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Monitors</strong>
            <span class="small-muted">Status = latest check</span>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-striped mb-0">
                <thead>
                  <tr>
                    <th style="width: 80px;">ID</th>
                    <th>Name</th>
                    <th>URL</th>
                    <th style="width: 170px;">Status</th>
                    <th style="width: 170px;">Last check</th>
                    <th style="width: 150px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="monitorsBody">
                  <tr><td colspan="6" class="text-center p-4 small-muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card shadow-sm mt-3">
          <div class="card-header">
            <strong>Recent checks (selected monitor)</strong>
          </div>
          <div class="card-body">
            <div class="small-muted mb-2">Click a monitor row to view last 20 checks.</div>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Status</th>
                    <th>Code</th>
                    <th>Response (ms)</th>
                    <th>Error</th>
                  </tr>
                </thead>
                <tbody id="checksBody">
                  <tr><td colspan="5" class="text-center small-muted">No monitor selected</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>

<script>
const API = "";

function showMsg(text, type="info") {
  const el = document.getElementById("msg");
  el.className = "alert alert-" + type;
  el.textContent = text;
  el.classList.remove("d-none");
  setTimeout(() => el.classList.add("d-none"), 3500);
}

function badgeFor(latest) {
  if (!latest || latest.message) return '<span class="badge badge-unknown">UNKNOWN</span>';
  if (latest.is_up) return '<span class="badge badge-up">UP</span>';
  return '<span class="badge badge-down">DOWN</span>';
}

function fmtTime(x) {
  if (!x) return "-";
  // FastAPI returns ISO-ish; show compact
  return String(x).replace("T", " ").replace("Z", "");
}

async function fetchJSON(url, opts) {
  const r = await fetch(url, opts);
  if (!r.ok) {
    const t = await r.text();
    throw new Error(t || ("HTTP " + r.status));
  }
  return await r.json();
}

let selectedMonitorId = null;

async function loadMonitors() {
  const body = document.getElementById("monitorsBody");
  const monitors = await fetchJSON("/monitors");
  if (!monitors.length) {
    body.innerHTML = '<tr><td colspan="6" class="text-center p-4 small-muted">No monitors yet. Add one!</td></tr>';
    return;
  }

  // fetch latest for each monitor (simple MVP approach)
  const latestMap = {};
  await Promise.all(monitors.map(async m => {
    try {
      latestMap[m.id] = await fetchJSON(`/monitors/${m.id}/latest`);
    } catch {
      latestMap[m.id] = {message: "No checks yet"};
    }
  }));

  body.innerHTML = monitors.map(m => {
    const latest = latestMap[m.id];
    const statusBadge = badgeFor(latest);
    const lastTime = latest && !latest.message ? fmtTime(latest.checked_at) : "-";
    const activeBtn = m.is_active
      ? `<button class="btn btn-sm btn-warning" data-action="toggle" data-id="${m.id}" data-active="true">Disable</button>`
      : `<button class="btn btn-sm btn-success" data-action="toggle" data-id="${m.id}" data-active="false">Enable</button>`;
    return `
      <tr data-row-id="${m.id}" style="cursor:pointer">
        <td class="mono">${m.id}</td>
        <td><strong>${escapeHtml(m.name)}</strong></td>
        <td class="mono text-truncate" style="max-width:240px" title="${escapeHtml(m.url)}">${escapeHtml(m.url)}</td>
        <td>${statusBadge} <span class="small-muted ms-2">${latest && !latest.message ? (latest.response_ms ?? "-") + "ms" : ""}</span></td>
        <td class="mono">${lastTime}</td>
        <td class="d-flex gap-1">
          ${activeBtn}
          <button class="btn btn-sm btn-outline-danger" data-action="delete" data-id="${m.id}">Delete</button>
        </td>
      </tr>
    `;
  }).join("");

  // row click selects monitor
  document.querySelectorAll("tr[data-row-id]").forEach(tr => {
    tr.addEventListener("click", (e) => {
      // prevent clicking buttons from selecting
      if (e.target && e.target.dataset && e.target.dataset.action) return;
      const id = Number(tr.dataset.rowId);
      selectedMonitorId = id;
      loadChecks(id);
      // highlight
      document.querySelectorAll("tr[data-row-id]").forEach(x => x.classList.remove("table-primary"));
      tr.classList.add("table-primary");
    });
  });

  // buttons actions
  document.querySelectorAll("button[data-action]").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      e.stopPropagation();
      const action = btn.dataset.action;
      const id = Number(btn.dataset.id);
      if (action === "delete") {
        if (!confirm("Delete monitor #" + id + "?")) return;
        await fetchJSON(`/monitors/${id}`, { method: "DELETE" });
        showMsg("Deleted monitor #" + id, "success");
        if (selectedMonitorId === id) {
          selectedMonitorId = null;
          document.getElementById("checksBody").innerHTML = '<tr><td colspan="5" class="text-center small-muted">No monitor selected</td></tr>';
        }
        await loadMonitors();
      } else if (action === "toggle") {
        const currentlyActive = btn.dataset.active === "true";
        await fetchJSON(`/monitors/${id}`, {
          method: "PATCH",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ is_active: !currentlyActive })
        });
        showMsg((!currentlyActive ? "Enabled" : "Disabled") + " monitor #" + id, "success");
        await loadMonitors();
      }
    });
  });
}

async function loadChecks(id) {
  const body = document.getElementById("checksBody");
  body.innerHTML = '<tr><td colspan="5" class="text-center small-muted">Loading checks...</td></tr>';
  const rows = await fetchJSON(`/monitors/${id}/checks?limit=20`);
  if (!rows.length) {
    body.innerHTML = '<tr><td colspan="5" class="text-center small-muted">No checks yet</td></tr>';
    return;
  }
  body.innerHTML = rows.map(r => `
    <tr>
      <td class="mono">${fmtTime(r.checked_at)}</td>
      <td>${r.is_up ? '<span class="badge badge-up">UP</span>' : '<span class="badge badge-down">DOWN</span>'}</td>
      <td class="mono">${r.status_code ?? "-"}</td>
      <td class="mono">${r.response_ms ?? "-"}</td>
      <td class="mono text-truncate" style="max-width:260px" title="${escapeHtml(r.error ?? "")}">${escapeHtml(r.error ?? "")}</td>
    </tr>
  `).join("");
}

function escapeHtml(s) {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

document.getElementById("addForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const payload = {
    name: fd.get("name"),
    url: fd.get("url"),
    interval_seconds: Number(fd.get("interval_seconds"))
  };
  try {
    await fetchJSON("/monitors", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    e.target.reset();
    showMsg("Monitor added!", "success");
    await loadMonitors();
  } catch (err) {
    showMsg("Error: " + err.message, "danger");
  }
});

document.getElementById("btnRefresh").addEventListener("click", async () => {
  await loadMonitors();
  if (selectedMonitorId) await loadChecks(selectedMonitorId);
});

document.getElementById("btnRunOnce").addEventListener("click", async () => {
  try {
    const res = await fetchJSON("/run-once", { method: "POST" });
    showMsg("Checks done. Checked: " + res.checked, "success");
    await loadMonitors();
    if (selectedMonitorId) await loadChecks(selectedMonitorId);
  } catch (err) {
    showMsg("Error: " + err.message, "danger");
  }
});

let timer = null;
function setAutoRefresh(on) {
  if (timer) clearInterval(timer);
  if (on) timer = setInterval(async () => {
    await loadMonitors();
    if (selectedMonitorId) await loadChecks(selectedMonitorId);
  }, 10000);
}
document.getElementById("autoRefresh").addEventListener("change", (e) => setAutoRefresh(e.target.checked));

(async function init(){
  await loadMonitors();
  setAutoRefresh(true);
})();
</script>

</body>
</html>
